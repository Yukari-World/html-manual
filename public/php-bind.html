<!DOCTYPE html>
<html lang="ja">

<head>
	<meta charset="utf-8">
	<title>バインドを利用したSQLの実行 - HTML Technical Manual</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="theme-color" content="#000011">
	<link rel="preload" type="text/css" href="css/prism.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" type="text/css" href="css/prism.min.css"></noscript>
	<link rel="preload" type="text/css" href="css/style.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" type="text/css" href="css/style.min.css"></noscript>
	<script type="application/javascript">
		/*! loadCSS. [c]2017 Filament Group, Inc. MIT License */
		(function(a) {
			if (!a.loadCSS) {
				a.loadCSS = function() {}
			}
			var b = loadCSS.relpreload = {};
			b.support = (function() {
				var d;
				try {
					d = a.document.createElement("link").relList.supports("preload")
				} catch (f) {
					d = false
				}
				return function() {
					return d
				}
			})();
			b.bindMediaToggle = function(e) {
				var f = e.media || "all";

				function d() {
					e.media = f
				}
				if (e.addEventListener) {
					e.addEventListener("load", d)
				} else {
					if (e.attachEvent) {
						e.attachEvent("onload", d)
					}
				}
				setTimeout(function() {
					e.rel = "stylesheet";
					e.media = "only x"
				});
				setTimeout(d, 3000)
			};
			b.poly = function() {
				if (b.support()) {
					return
				}
				var d = a.document.getElementsByTagName("link");
				for (var e = 0; e < d.length; e++) {
					var f = d[e];
					if (f.rel === "preload" && f.getAttribute("as") === "style" && !f.getAttribute("data-loadcss")) {
						f.setAttribute("data-loadcss", true);
						b.bindMediaToggle(f)
					}
				}
			};
			if (!b.support()) {
				b.poly();
				var c = a.setInterval(b.poly, 500);
				if (a.addEventListener) {
					a.addEventListener("load", function() {
						b.poly();
						a.clearInterval(c)
					})
				} else {
					if (a.attachEvent) {
						a.attachEvent("onload", function() {
							b.poly();
							a.clearInterval(c)
						})
					}
				}
			}
			if (typeof exports !== "undefined") {
				exports.loadCSS = loadCSS
			} else {
				a.loadCSS = loadCSS
			}
		}(typeof global !== "undefined" ? global : this));

	</script>
</head>

<body>
	<header class="md-show" id="top" role="banner">
		<h1>バインドを利用したSQLの実行</h1><label for="menuBtn">Menu</label></header><input class="panel-switch" id="menuBtn" type="checkbox">
	<nav class="sidebar" id="menu">
		<h2>HTML Manual Menu</h2>
		<div class="nav-button"><button id="expandAll">全て展開</button><button id="collapseAll">全て折りたたむ</button></div>
		<ul>
			<li>
				<h3><label class="expand-box" id="btnMain" for="linkMain">+</label><a href="" title="Main">Main</a></h3><input class="panel-switch" id="linkMain" type="checkbox">
				<ul id="listMain">
					<li><a href="index.html" title="TOP Page">TOP Page</a></li>
					<li><a href="scp-prismHighlight.html" title="Prismハイライトの例">Prismハイライトの例</a></li>
					<li><a href="scp-sample.html" title="サンプルデータ">サンプルデータ</a></li>
					<li><a href="scp-updateLog.html" title="更新履歴">更新履歴</a></li>
					<li><a href="scp-randomWord.html" title="???">???</a></li>
				</ul>
			</li>
			<li>
				<h3><label class="expand-box" id="btnCSS" for="linkCSS">+</label><a href="" title="CSS">CSS</a></h3><input class="panel-switch" id="linkCSS" type="checkbox">
				<ul id="listCSS">
					<li><a href="css-backgroundLayer.html">backgroundを重ねる</a></li>
					<li><a href="css-disablebrTag.html">brタグによる改行を無効化</a></li>
					<li><a href="css-beforeAfter.html">疑似要素 :before / :after</a></li>
					<li><a href="css-gradation.html">グラデーション</a></li>
					<li><a href="css-backgroundScrollLock.html">背景画像スクロールの固定</a></li>
					<li><a href="css-fadeIn.html">フェードイン</a></li>
					<li><a href="css-textShadow.html">文字装飾による可読性の向上</a></li>
				</ul>
			</li>
			<li>
				<h3><label class="expand-box" id="btnHTML" for="linkHTML">+</label><a href="" title="HTML">HTML</a></h3><input class="panel-switch" id="linkHTML" type="checkbox">
				<ul id="listHTML">
					<li><a href="html-omitHttp.html" title="[Deprecated] httpの省略">[Deprecated] httpの省略</a></li>
					<li><a href="#" title="[WIP] ファイルダウンロード">[WIP] ファイルダウンロード</a></li>
				</ul>
			</li>
			<li>
				<h3><label class="expand-box" id="btnJavaScript" for="linkJavaScript">+</label><a href="" title="JavaScript">JavaScript</a></h3><input class="panel-switch" id="linkJavaScript" type="checkbox">
				<ul id="listJavaScript">
					<li><a href="js-FetchAPI.html" title="[WIP] Fetch API">[WIP] Fetch API</a></li>
					<li><a href="js-localStorage.html" title="[WIP] localStorage">[WIP] localStorage</a></li>
					<li><a href="js-Promise.html" title="[WIP] Promise">[WIP] Promise</a></li>
					<li><a href="js-XMLHttpRequest.html" title="[WIP] XMLHttpRequest">[WIP] XMLHttpRequest</a></li>
				</ul>
			</li>
			<li>
				<h3><label class="expand-box" id="btnLanguage" for="linkLanguage">+</label><a href="" title="Language">Language</a></h3><input class="panel-switch" id="linkLanguage" type="checkbox">
				<ul id="listLanguage">
					<li><a href="#" title="[WIP] CSS">[WIP] CSS</a></li>
					<li><a href="language-pug.html" title="Pug">Pug</a></li>
					<li><a href="language-sass.html" title="Sass">Sass</a></li>
					<li><a href="#" title="[WIP] SCSS">[WIP] SCSS</a></li>
				</ul>
			</li>
			<li>
				<h3><label class="expand-box" id="btnNode" for="linkNode">+</label><a href="" title="Node.js">Node.js</a></h3><input class="panel-switch" id="linkNode" type="checkbox">
				<ul id="listNode">
					<li><a href="#" title="[WIP] Node.js導入マニュアル">[WIP] Node.js導入マニュアル</a></li>
					<li><a href="node-manualBrowsersync.html" title="Browsersync導入マニュアル">Browsersync導入マニュアル</a></li>
					<li><a href="node-npm.html" title="npm コマンド">npm コマンド</a></li>
					<li><a href="#" title="[Gulp/WIP] Gulp導入マニュアル">[Gulp/WIP] Gulp導入マニュアル</a></li>
				</ul>
			</li>
			<li>
				<h3><label class="expand-box" id="btnPHP" for="linkPHP">+</label><a href="" title="PHP">PHP</a></h3><input class="panel-switch" id="linkPHP" type="checkbox">
				<ul id="listPHP">
					<li><a href="php-pdo.html" title="PDO(PHP Data Objects)">PDO(PHP Data Objects)</a></li>
					<li><a href="php-bind.html" title="バインドを利用したSQLの実行">バインドを利用したSQLの実行</a></li>
					<li><a href="php-date.html" title="日付時間 date()">日付時間 date()</a></li>
					<li><a href="php-fileProcessLock.html" title="ファイルを利用した二重起動防止">ファイルを利用した二重起動防止</a></li>
				</ul>
			</li>
			<li>
				<h3><label class="expand-box" id="btnSCSS" for="linkSCSS">+</label><a href="" title="SCSS">SCSS</a></h3><input class="panel-switch" id="linkSCSS" type="checkbox">
				<ul id="listSCSS"></ul>
			</li>
			<li>
				<h3><label class="expand-box" id="btnSQL" for="linkSQL">+</label><a href="" title="SQL">SQL</a></h3><input class="panel-switch" id="linkSQL" type="checkbox">
				<ul id="listSQL">
					<li><a href="sql-insertSelect.html" title="INSERT SELECT">INSERT SELECT</a></li>
					<li><a href="sql-join.html" title="JOIN(テーブル結合)">JOIN(テーブル結合)</a></li>
					<li><a href="#" title="[WIP] LIKE(あいまい検索)">[WIP] LIKE(あいまい検索)</a></li>
					<li><a href="sql-transaction.html" title="TRANSACTION(トランザクション)">TRANSACTION(トランザクション)</a></li>
					<li><a href="sql-truncate.html" title="TRUNCATE(テーブルを空にする)">TRUNCATE(テーブルを空にする)</a></li>
					<li><a href="#" title="[WIP] 削除フラグ">[WIP] 削除フラグ</a></li>
					<li><a href="sql-MySQLinsertWhereExists.html" title="[MySQL] INSERT WHERE EXISTS">[MySQL] INSERT WHERE EXISTS</a></li>
					<li><a href="sql-MySQLint.html" title="[MySQL] INT(11) の意味">[MySQL] INT(11) の意味</a></li>
					<li><a href="sql-MySQLupdateSelect.html" title="[MySQL] UPDATE SELECT">[MySQL] UPDATE SELECT</a></li>
					<li><a href="#" title="[MySQL/WIP] UTF-8のあれこれ">[MySQL/WIP] UTF-8のあれこれ</a></li>
				</ul>
			</li>
			<li>
				<h3><label class="expand-box" id="btnOther" for="linkOther">+</label><a href="" title="Other">Other</a></h3><input class="panel-switch" id="linkOther" type="checkbox">
				<ul id="listOther">
					<li><a href="#" title="[Atom/WIP] Atom 導入マニュアル">[Atom/WIP] Atom 導入マニュアル</a></li>
					<li><a href="#" title="[Atom/WIP] apm Command">[Atom/WIP] apm Command</a></li>
					<li><a href="#" title="[Unix/WIP] Console Command">[Unix/WIP] Console Command</a></li>
					<li><a href="#" title="[XAMPP/WIP] ローカルネットワーク接続">[XAMPP/WIP] ローカルネットワーク接続</a></li>
				</ul>
			</li>
		</ul>
	</nav>
	<div class="content">
		<header class="md-hide" role="banner">
			<h1>バインドを利用したSQLの実行</h1></header>
		<main role="main">
			<section>
				<h2>説明</h2>
				<p>SQLコードを作成する時、外部からの値を参照して実行することがある。その際入力欄に制限等が成されていない場合、不正な値やSQLコードを入力される可能性がある。その問題を全てではないが防ぐ事ができる方法でもあるバインドについて説明する。</p>
			</section>
			<section>
				<h2>使用方法と解説</h2>
				<p>まずはバインドを使用しない例から記述。<br>よくあるミスだが、パスワードは文字列なのでクォーテーションで囲むのを忘れないように注意。<br>また、本来アスタリスク(*)はテスト以外に使用することは推奨されないので要注意。これはデータベースのデータ数が多くなる程レスポンスの低下やメモリ使用量の増大、データの隠密性等多くの問題が発生するためである。</p>
				<h3>MySQLi</h3><pre class="language-php line-numbers" data-line="1"><code>$query = "SELECT * FROM `user` WHERE `id` = " . $id . " AND `password` = PASSWORD('" . $password . "')";
// SQLの実行
if ($result = $mysqli-&gt;query($query)) {
	// 結果の取得
	while ($row = $result-&gt;fetch_assoc()) {
		$user[] = $row;
	}

	// 結果を閉じる
	$result-&gt;close();
}
</code></pre>
				<p>fetch_allに関してはmysqlndというネイティブドライバでのみ使用可能なため、使用を避けている。しかし問題点として上記のSQLの内容では問題とはならないが、処理の結果数千行となる場合は処理方法を工夫する必要が出てくる可能性があるため注意。</p>
				<h3>PDO</h3><pre class="language-php line-numbers" data-line="2"><code>try {
	$query = "SELECT * FROM `user` WHERE `id` = " . $id . " AND `password` = PASSWORD('" . $password . "')";
	$stmt = $pdo-&gt;prepare($query); // SQL Queryの格納
	$stmt-&gt;execute(); // SQLの実行
	$result = $stmt-&gt;fetchAll(PDO::FETCH_ASSOC); // SQLの結果を取得

	// SQLの実行に失敗しておらず、取得結果がある場合、変数に格納
	if ($result !== false &amp;&amp; count($result) &gt; 0) {
		$user = $result;
	} else {
		throw(new Exception('Result is NULL!!'));
	}
} catch (PDOException $e) {
	die('Database Error: ' . $e-&gt;getMessage());
}
</code></pre>
				<p>このままでも問題はないように見えるが、入力する変数の種類に指定がないため<a href="https://ja.wikipedia.org/wiki/SQL%E3%82%A4%E3%83%B3%E3%82%B8%E3%82%A7%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3" title="SQLインジェクション" target="_blank">SQLインジェクション</a>などの問題が発生する可能性がある。もちろんこの記述方法を使う場合は大抵の場合これより手前で整合性の確認や無害化が行われている筈であるが、行っていないのであればまずはそこから見直すべきである。起こってからでは手遅れである。</p>
				<p>次に上のソースコードを基にバインドを利用した記述。</p>
				<h3>MySQLi</h3><pre class="language-php line-numbers" data-line="1-9"><code>$query = "SELECT * FROM `user` WHERE `id` = ? AND `password` = PASSWORD(?)";
// SQL Queryの格納
if ($stmt = $mysqli-&gt;prepare($query)) {
	// バインド
	$stmt-&gt;bind_param("is", $(int)$id, $password);
	$stmt-&gt;execute(); // SQLの実行

	// 結果の格納(列の数だけ指定)
	$stmt-&gt;bind_result($col1, $col2, $col3, ...);

	// 結果の取得
	while ($stmt-&gt;fetch()) {
		$user[] = array($col1, $col2, $col3, ...);
	}

	// 結果を閉じる
	$result-&gt;close();
}
</code></pre>
				<p>MySQLiの例。SQLに値を代入する位置にプレースホルダ`?`を挿入して指定した後一度<code class="language-php"><span class="token function">prepare</span></code>に格納する必要がある。格納した後にバインドする。<br><code class="language-php"><span class="token function">bind_param</span></code>の第一引数は代入する変数の型を示しており、iはinterger数値を示しており、sはstring文字列を示している。第二引数以降には変数を指定する。直接値や文字列を指定することはできないので注意が必要。</p>
				<h3>PDO</h3><pre class="language-php line-numbers" data-line="2,4-6"><code>try {
	$query = "SELECT * FROM `user` WHERE `id` = :id AND `password` = PASSWORD(:password)";
	$stmt = $pdo-&gt;prepare($query); // SQL Queryの格納
	// バインド
	$stmt-&gt;bindValue(':id', (int)$id, PDO::PARAM_INT);
	$stmt-&gt;bindValue(':password', $password, PDO::PARAM_STR);
	$stmt-&gt;execute(); // SQLの実行
	$result = $stmt-&gt;fetchAll(PDO::FETCH_ASSOC); // SQLの結果を取得

	// SQLの実行に失敗しておらず、取得結果がある場合、変数に格納
	if ($result !== false &amp;&amp; count($result) &gt; 0) {
		$user = $result;
	} else {
		throw(new Exception('Result is NULL!!'));
	}
} catch (PDOException $e) {
	die('Database Error: ' . $e-&gt;getMessage());
}
</code></pre>
				<p>PDOの例。基本的な記述方法は殆ど変わらない。<br>プレースホルダ?を使用する代わりに文字列でプレースホルダを作成することができる。文字列で作成する場合、先頭は必ずコロンで始まる。<br><code class="language-php"><span class="token function">bindValue</span></code>の第一引数は代入するプレースホルダの位置を示しており、第二引数は代入する変数、もしくは値を示している。第三引数は変数の型を指定する。指定できる内容は以下の通りである。</p>
				<ul>
					<li><code class="language-php"><span class="token scope">PDO<span class="token punctuation">::</span></span><span class="token constant">PARAM_BOOL</span></code></li>
					<li><code class="language-php"><span class="token scope">PDO<span class="token punctuation">::</span></span><span class="token constant">PARAM_NULL</span></code></li>
					<li><code class="language-php"><span class="token scope">PDO<span class="token punctuation">::</span></span><span class="token constant">PARAM_INT</span></code></li>
					<li><code class="language-php"><span class="token scope">PDO<span class="token punctuation">::</span></span><span class="token constant">PARAM_STR</span></code></li>
					<li><code class="language-php"><span class="token scope">PDO<span class="token punctuation">::</span></span><span class="token constant">PARAM_LOB</span></code></li>
				</ul>
				<p>似た関数に<code class="language-php"><span class="token function">bindParam</span></code>があるが、こちらは変数の取扱が異なり文字列として扱われる。また、整合性の確認タイミングも異なり、<code class="language-php"><span class="token function">bindValue</span></code>は代入直後、<code class="language-php"><span class="token function">bindParam</span></code>は実行直前に行われる。また、
					<code
					    class="language-php"><span class="token function">bindParam</span></code>は直接値を取り扱うことができず、必ず変数を指定する必要がある。</p>
			</section>
			<section>
				<h2>使用上の注意</h2>
				<ul>
					<li>プレースホルダに代入する値は再代入が可能である。その仕様を利用して同じSQL文を繰り返して実行することができる。</li>
					<li>MySQLiのプレースホルダには名前での宣言はできない。名前を利用してバインドする場合はPDOに頼るしかない。</li>
					<li>指定した型以外の変数が代入された場合、例外処理が実行される。</li>
					<li>文字列のクォーテーションは自動で囲われるので不要である。</li>
					<li>日付や時間を取り扱う場合は文字列を指定する。</li>
				</ul>
			</section>
			<section>
				<h2>参考リンク</h2>
				<p><a href="http://php.net/manual/ja/mysqli-stmt.bind-param.php" target="_blank">PHP.net / mysqli_stmt::bind_param</a><br><a href="http://php.net/manual/ja/mysqli-stmt.bind-result.php" target="_blank">PHP.net / mysqli_stmt::bind_result</a><br><a href="http://php.net/manual/ja/pdostatement.bindparam.php"
					    target="_blank">PHP.net / PDOStatement::bindParam</a><br><a href="http://php.net/manual/ja/pdostatement.bindvalue.php" target="_blank">PHP.net / PDOStatement::bindValue</a></p>
			</section>
		</main>
		<footer role="contentinfo">
			<p id="randomWord">Loading...</p>
			<p>Page Editor, Page Design: Yukari-World<br>Text Editor:&nbsp;<a href="https://atom.io/" title="Atom" target="_blank">Atom</a>,&nbsp;<a href="https://notepad-plus-plus.org/" title="Notepad++ Home" target="_blank">Notepad++</a>,&nbsp;<a href="https://code.visualstudio.com/"
				    title="Visual Studio Code - Code Editing. Redefined" target="_blank">Visual Stdio Code</a><br>Syntax Highlightor:&nbsp;<a href="https://prismjs.com/" title="Prism" target="_blank">Prism</a><br>Coding Language: JavaScript,&nbsp;<a href="https://pugjs.org/"
				    title="Pug: Getting Started" target="_blank">Pug(Jade)</a>,&nbsp;<a href="http://sass-lang.com/" title="Sass: Syntactically Awesome Style Sheets" target="_blank">Sass(SCSS)</a></p>
		</footer>
	</div>
	<script type="application/javascript" src="js/prism.min.js"></script>
	<script type="application/javascript" src="js/index.js"></script>
</body>

</html>
